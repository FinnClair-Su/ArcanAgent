# ArcanAgent Backend 优化待办事项

## 当前状态评估
✅ **已完成**: 5个Arcana Agent系统完整实现，双向链接引擎核心功能完备
⚠️ **需要优化**: 系统架构组件、工具调用机制、上下文工程系统化
🚨 **缺失**: API服务器、工具调用循环引擎、系统化的上下文管理器

---

## 🚀 优先级1: 核心架构补充 (关键缺失)

### 1.1 工具调用循环引擎 - 符合NagaAgent SPEC
**目标**: 实现SPEC要求的`<<<[TOOL_REQUEST]>>>`格式和递归调用机制

**具体任务**:
- [ ] 创建 `backend/core/tool_call_engine.py` 的完整实现
- [ ] 实现 `<<<[TOOL_REQUEST]>>>` 格式解析器
- [ ] 支持 `agentType: 「始」arcana「末」` 语法
- [ ] 实现递归工具调用循环 (max_recursion=5)
- [ ] 集成现有的5个Arcana Agent到工具调用系统
- [ ] 添加工具调用结果的自动回传机制

**验收标准**:
```python
# 期望的调用格式
tool_request = """
<<<[TOOL_REQUEST]>>>
agentType: 「始」arcana「末」
agent_name: 「始」the_high_priestess「末」
query: 「始」评估用户当前知识状态「末」
<<<[END_TOOL_REQUEST]>>>
"""
result = await tool_engine.handle_tool_call_loop(messages)
```

### 1.2 系统化上下文管理器 - 严格遵循6个原则
**目标**: 实现SPEC要求的KV-Cache优化和上下文工程原则

**具体任务**:
- [ ] 重构 `backend/core/context_manager.py` 为完整实现
- [ ] 实现KV-Cache友好的静态前缀系统
- [ ] 添加文件系统作为外部记忆机制
- [ ] 实现确定性序列化的工具定义
- [ ] 添加分层上下文内容外部化
- [ ] 实现只追加的交互历史管理
- [ ] 添加上下文多样性和错误保留机制

**验收标准**:
```python
context_manager.build_learning_context(
    user_query="学习机器学习",
    zpd_info=zpd_data,
    relevant_notes=notes
) 
# 应返回KV-Cache优化的上下文字符串
```

### 1.3 FastAPI服务器和API端点
**目标**: 提供完整的RESTful API服务

**具体任务**:
- [ ] 创建 `backend/api/main.py` FastAPI应用
- [ ] 实现学习流程API端点:
  - [ ] `POST /api/v1/learning/assess-knowledge`
  - [ ] `POST /api/v1/learning/plan-path`
  - [ ] `POST /api/v1/learning/generate-content`
  - [ ] `POST /api/v1/learning/check-understanding`
  - [ ] `POST /api/v1/learning/consolidate-memory`
- [ ] 实现知识库管理API:
  - [ ] `GET /api/v1/notes`
  - [ ] `GET /api/v1/notes/{note_id}`
  - [ ] `PUT /api/v1/notes/{note_id}`
  - [ ] `GET /api/v1/notes/{note_id}/links`
- [ ] 实现图谱可视化API:
  - [ ] `GET /api/v1/graph/overview`
  - [ ] `GET /api/v1/graph/path/{from}/{to}`
- [ ] 添加WebSocket支持用于实时学习进度
- [ ] 集成Agent编排器到API端点
- [ ] 添加请求验证和错误处理

---

## 🔧 优先级2: 现有系统优化 (重要提升)

### 2.1 双向链接引擎优化
**目标**: 提升性能和功能完整性

**具体任务**:
- [ ] 优化 `BidirectionalLinkEngine` 的内存索引性能
- [ ] 实现异步文件I/O操作
- [ ] 添加链接密度自动调整算法
- [ ] 实现智能相关性分析的LLM集成
- [ ] 添加链接质量评分机制
- [ ] 优化分层上下文选择策略
- [ ] 添加链接图的最短路径算法
- [ ] 实现链接强度动态更新

### 2.2 LLM客户端接口优化
**目标**: 支持多模型和性能优化

**具体任务**:
- [ ] 完善 `backend/core/llm_client.py` 的多提供商支持
- [ ] 添加Deepseek API集成
- [ ] 添加阿里云通义千问API集成
- [ ] 实现KV-Cache友好的请求格式
- [ ] 添加请求重试和错误恢复机制
- [ ] 实现模型响应缓存机制
- [ ] 添加API成本监控和限制
- [ ] 优化温度参数的动态调整

### 2.3 Agent系统优化
**目标**: 提升Agent协作效率和可靠性

**具体任务**:
- [ ] 优化Agent间的上下文传递机制
- [ ] 添加Agent执行失败的恢复策略
- [ ] 实现Agent并行执行的可能性评估
- [ ] 添加Agent性能监控和统计
- [ ] 优化Agent内存使用和清理机制
- [ ] 实现Agent执行结果的缓存
- [ ] 添加Agent配置的动态调整
- [ ] 完善Agent错误日志和诊断

---

## 🏗️ 优先级3: 架构完善 (长期优化)

### 3.1 配置系统优化
**目标**: 借鉴NagaAgent的Pydantic配置系统

**具体任务**:
- [ ] 创建 `backend/core/config.py` 配置管理系统
- [ ] 实现类型安全的配置验证
- [ ] 支持环境变量和JSON文件混合加载
- [ ] 添加配置热重载机制
- [ ] 实现配置版本管理
- [ ] 添加配置安全性检查
- [ ] 创建配置文档和示例

### 3.2 文件系统管理优化
**目标**: 提升Obsidian兼容性和性能

**具体任务**:
- [ ] 优化markdown文件解析性能
- [ ] 实现文件变更的实时监控
- [ ] 添加文件锁机制防止并发冲突
- [ ] 优化元数据索引的持久化
- [ ] 实现增量索引更新
- [ ] 添加文件备份和恢复机制
- [ ] 优化大文件的处理策略

### 3.3 缓存和性能优化
**目标**: 支持大规模知识库的高效处理

**具体任务**:
- [ ] 实现多层缓存策略 (内存+文件)
- [ ] 添加LRU缓存淘汰机制
- [ ] 优化双向链接图的存储结构
- [ ] 实现异步任务队列
- [ ] 添加数据库连接池管理
- [ ] 优化并发请求处理
- [ ] 实现性能监控和报警

---

## 🧪 优先级4: 测试和质量保证

### 4.1 单元测试补充
**具体任务**:
- [ ] 为所有Agent编写单元测试
- [ ] 测试双向链接引擎的各种场景
- [ ] 测试上下文管理器的6个原则实现
- [ ] 测试工具调用循环的递归逻辑
- [ ] 测试LLM客户端的多提供商支持
- [ ] 测试配置系统的验证机制

### 4.2 集成测试建立
**具体任务**:
- [ ] 端到端学习流程测试
- [ ] Agent协作流程测试
- [ ] API端点的集成测试
- [ ] 文件系统一致性测试
- [ ] 并发请求压力测试
- [ ] 错误恢复场景测试

### 4.3 性能测试
**具体任务**:
- [ ] 大规模笔记处理性能基准
- [ ] KV-Cache命中率测试
- [ ] 内存使用优化验证
- [ ] API响应时间测试
- [ ] 并发用户负载测试

---

## 📋 执行计划

### 第1周: 核心架构补充
- [ ] 天1-2: 工具调用循环引擎实现
- [ ] 天3-4: 系统化上下文管理器
- [ ] 天5-7: FastAPI服务器和基础API

### 第2周: API完善和Agent优化
- [ ] 天1-3: 完成所有API端点实现
- [ ] 天4-5: 双向链接引擎优化
- [ ] 天6-7: Agent系统优化

### 第3周: 系统完善和测试
- [ ] 天1-2: 配置系统和文件管理优化
- [ ] 天3-4: 缓存和性能优化
- [ ] 天5-7: 测试体系建立和验证

## 🎯 成功标准

1. ✅ 完整的工具调用循环机制按SPEC工作
2. ✅ 6个上下文工程原则完全实现
3. ✅ 所有API端点正常工作并通过测试
4. ✅ 支持1000+笔记的高效处理
5. ✅ KV-Cache优化显著降低API成本
6. ✅ Agent协作流程稳定可靠
7. ✅ 完全兼容Obsidian文件格式

## 📊 当前进度跟踪

- [x] Arcana Agent系统实现 (100%)
- [x] 基础双向链接引擎 (80%)  
- [x] Agent编排器 (90%)
- [ ] 工具调用循环引擎 (0%)
- [ ] 系统化上下文管理器 (30%)
- [ ] FastAPI服务器 (0%)
- [ ] API端点实现 (0%)
- [ ] 测试体系 (10%)

**总体进度: 35%** 
**预计完成时间: 3周**