# ArcanAgent 实施计划

## 阶段一：基础架构搭建 (基于NagaAgent成功经验)

### 1. 项目初始化和配置系统
- [ ] 1.1 创建项目目录结构
  - 参考NagaAgent的目录组织方式
  - 建立前后端分离的清晰架构
  - 配置pyproject.toml和依赖管理
  - _需求: 需求7 - Obsidian兼容性_

- [ ] 1.2 实现Pydantic配置系统
  - 直接借鉴NagaAgent的config.py设计模式
  - 支持JSON文件和环境变量混合配置
  - 类型安全的配置验证和错误处理
  - 配置热重载机制
  - _需求: 架构约束 - 性能要求_

- [ ] 1.3 建立日志和错误处理系统
  - 采用NagaAgent的日志配置模式
  - 结构化日志输出和级别控制
  - 错误信息完整保留(上下文工程原则5)
  - _需求: 架构约束 - 上下文工程原则_

### 2. 核心引擎开发

- [ ] 2.1 工具调用循环引擎
  - 完全参考NagaAgent的conversation_core.py工具调用机制
  - 实现TOOL_REQUEST格式解析
  - 支持递归工具调用和上下文传递
  - 实现最大循环次数限制和错误恢复
  - _需求: 需求1-5 - 完整学习流程_

- [ ] 2.2 双向链接引擎核心
  - 实现markdown文件的[[]]链接解析
  - 建立内存索引和持久化机制
  - 实现分层上下文选择策略(全文/摘要/标题)
  - 确保Obsidian完全兼容
  - _需求: 需求3 - 智能上下文选择与内容生成, 需求7 - Obsidian兼容性_

- [ ] 2.3 上下文管理器
  - 严格实现6个上下文工程原则
  - KV-Cache优化的静态前缀系统
  - 文件系统外部记忆扩展
  - 确定性序列化和上下文多样性
  - _需求: 架构约束 - 6个上下文工程原则_

## 阶段二：Arcana Agent系统

### 3. 简化的Arcana Agent系统

- [ ] 3.1 Agent基类和统一接口
  - 定义5个固定Arcana Agent的基类
  - 借鉴NagaAgent的会话管理和LLM调用模式
  - 实现统一的Agent调用接口，无需动态发现
  - 会话隔离和上下文管理
  - _需求: 需求1-5 - 各个Agent的具体功能_

- [ ] 3.2 Agent管理器(简化版)
  - 直接实例化5个固定Agent，无需注册机制
  - 实现Agent间的流水线协作
  - 会话历史维护和清理
  - 异步LLM API调用封装
  - _需求: 需求1-5 - Agent协作流程_

### 4. 五个核心Arcana Agent实现

- [ ] 4.1 The High Priestess - 知识评估Agent
  - 分析用户现有笔记和双向链接关系
  - 评估知识状态和掌握程度
  - 生成知识评估报告供用户确认
  - _需求: 需求1 - 知识状态评估与确认_

- [ ] 4.2 The Hermit - 路径规划Agent
  - 基于最近发展区理论进行路径规划
  - 分析双向链接密度和学习路径
  - 考虑认知负荷和概念复杂度
  - _需求: 需求2 - 最近发展区识别与学习路径规划_

- [ ] 4.3 The Magician - 内容生成Agent
  - 实现智能分层上下文选择
  - 生成个性化学习内容
  - 实时创建双向链接
  - 确保内容符合用户学习模式
  - _需求: 需求3 - 智能上下文选择与内容生成_

- [ ] 4.4 Justice - 理解检测Agent
  - 多样化的理解程度评估方式
  - 提供针对性反馈和建议
  - 根据检测结果调整后续内容难度
  - _需求: 需求4 - 理解程度检测_

- [ ] 4.5 The Empress - 记忆巩固Agent
  - 通过多种方式巩固新学知识
  - 整合新知识到现有知识网络
  - 更新markdown笔记和双向链接
  - 维护学习档案和进度记录
  - _需求: 需求5 - 记忆巩固与知识整合_

## 阶段三：API和前端系统

### 5. 后端API服务

- [ ] 5.1 FastAPI服务器搭建
  - 参考NagaAgent的api_server.py结构
  - 实现RESTful API端点
  - WebSocket实时通信支持
  - 自动API文档生成
  - _需求: 需求6 - 独立前端界面_

- [ ] 5.2 学习流程API实现
  - POST /api/v1/learning/assess-knowledge
  - POST /api/v1/learning/plan-path  
  - POST /api/v1/learning/generate-content
  - POST /api/v1/learning/check-understanding
  - POST /api/v1/learning/consolidate-memory
  - _需求: 需求1-5 - 完整学习流程API化_

- [ ] 5.3 知识库管理API
  - GET/PUT /api/v1/notes/{note_id}
  - GET /api/v1/notes/{note_id}/links
  - GET /api/v1/graph/overview
  - GET /api/v1/graph/path/{from}/{to}
  - _需求: 需求7 - Obsidian兼容性, 需求6 - 前端界面_

### 6. 前端界面开发

- [ ] 6.1 React前端基础架构
  - TypeScript + Tailwind CSS设置
  - Zustand状态管理配置
  - WebSocket客户端连接
  - _需求: 需求6 - 独立前端界面_

- [ ] 6.2 学习交互界面
  - 学习流程的步骤化界面
  - 实时学习进度显示
  - 理解检测交互组件
  - _需求: 需求1-5 - 用户交互界面_

- [ ] 6.3 知识图谱可视化
  - D3.js双向链接网络图
  - 节点点击、缩放、过滤功能
  - 学习路径的可视化展示
  - _需求: 需求2 - 学习路径可视化, 需求6 - 图谱界面_

## 阶段四：测试和优化

### 7. 测试体系建立

- [ ] 7.1 单元测试
  - 双向链接引擎测试
  - 上下文管理器测试
  - 各个Arcana Agent逻辑测试
  - 工具调用循环测试

- [ ] 7.2 集成测试
  - 完整学习流程端到端测试
  - Agent协作流程测试
  - 文件系统一致性测试

- [ ] 7.3 性能测试
  - 大规模笔记处理性能测试
  - KV-Cache命中率测试
  - 并发请求压力测试

### 8. 部署和文档

- [ ] 8.1 容器化部署
  - Docker配置和compose文件
  - 环境变量和配置管理
  - 日志和监控配置

- [ ] 8.2 用户文档
  - 快速开始指南
  - 配置说明文档
  - API使用文档
  - 学习流程用户手册

## 技术风险和缓解措施

### 高风险项目
1. **工具调用循环的稳定性** - 参考NagaAgent的成熟实现，降低风险
2. **双向链接的性能优化** - 采用内存索引+异步持久化策略
3. **LLM API调用的成本控制** - 实现KV-Cache优化和上下文压缩

### 缓解策略
1. **渐进式开发** - 每个阶段都有可运行的MVP版本
2. **早期测试** - 在核心功能完成后立即进行集成测试
3. **性能监控** - 从开发阶段就建立性能基准和监控

## 里程碑和时间估算

- **阶段一** (基础架构): 2-3周
- **阶段二** (Arcana系统): 3-4周  
- **阶段三** (API和前端): 2-3周
- **阶段四** (测试优化): 1-2周

**总计**: 8-12周完成完整的ArcanAgent系统

## 成功标准

1. ✅ 完整的学习流程能够流畅运行
2. ✅ 双向链接系统与Obsidian完全兼容
3. ✅ 响应时间满足用户体验要求
4. ✅ 支持数千个笔记节点的高效处理
5. ✅ KV-Cache优化显著降低API成本